<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="oms.settlebiz">

	<select id="getSettleBizList" parameterType="omsSettleSearch" resultType="omsSettleBiz">
	/* [oms.settlebiz.getSettleBizList][peter][2016. 10. 18.] */
		<include refid="ccs.common.pagingPre" />
			SELECT
				BUSINESS_ID
				, BUSINESS_NAME
				, SUM(SALE_AMT_SUM)						AS FINAL_SALE_AMT
				, SUM(CARD_SUM) + SUM(KAKAO_SUM)		AS FINAL_CARD_AMT
				, SUM(VIRTUAL_SUM) + SUM(TRANSFER_SUM)	AS FINAL_CASH_AMT
				, SUM(MOBILE_SUM)						AS FINAL_MOBILE_AMT
				, SUM(USE_POINT_SUM) + SUM(DEPOSIT_AMT_SUM) - SUM(CASH_REFUND_AMT_SUM) - SUM(DEPOSIT_REFUND_AMT_SUM)		AS FINAL_ETC_AMT
				, SUM(OWN_DC_AMT_SUM) + SUM(PLUS_COUPON_DC_AMT_SUM) + SUM(ORDER_COUPON_DC_AMT_SUM)		AS FINAL_OWN_COUPON_AMT
				, SUM(BIZ_DC_AMT_SUM)					AS FINAL_BIZ_COUPON_AMT
				, SUM(SALE_CHARGE_AMT)					AS FINAL_SALE_CHARGE_AMT
				, SUM(SALE_AMT_SUM) - SUM(SALE_CHARGE_AMT) - SUM(BIZ_DC_AMT_SUM)					AS FINAL_SUPPORT_AMT
			FROM (
				SELECT 
				    CB.BUSINESS_ID
				    , CB.NAME						AS BUSINESS_NAME
				    , OE.SALEPRODUCT_ID
				    , OE.COMMISSION_RATE
				    , SUM(DECODE(OE.ERP_ORDER_TYPE_CD, 'ERP_ORDER_TYPE_CD.RETURN', OE.SALE_AMT*(-1), OE.SALE_AMT))				AS SALE_AMT_SUM
				    , ROUND(SUM(DECODE(OE.ERP_ORDER_TYPE_CD, 'ERP_ORDER_TYPE_CD.RETURN', OE.SALE_AMT*(-1), OE.SALE_AMT)) * (OE.COMMISSION_RATE / 100), 0)	AS SALE_CHARGE_AMT
				    , NVL(SUM(DECODE(OE.PAYMENT_METHOD_CD,'PAYMENT_METHOD_CD.CARD',DECODE(OE.ERP_ORDER_TYPE_CD, 'ERP_ORDER_TYPE_CD.RETURN', OE.PAYMENT_AMT*(-1), OE.PAYMENT_AMT),0)),0)		AS CARD_SUM
				    , NVL(SUM(DECODE(OE.PAYMENT_METHOD_CD,'PAYMENT_METHOD_CD.VIRTUAL',DECODE(OE.ERP_ORDER_TYPE_CD, 'ERP_ORDER_TYPE_CD.RETURN', OE.PAYMENT_AMT*(-1), OE.PAYMENT_AMT),0)),0)	AS VIRTUAL_SUM
				    , NVL(SUM(DECODE(OE.PAYMENT_METHOD_CD,'PAYMENT_METHOD_CD.TRANSFER',DECODE(OE.ERP_ORDER_TYPE_CD, 'ERP_ORDER_TYPE_CD.RETURN', OE.PAYMENT_AMT*(-1), OE.PAYMENT_AMT),0)),0)	AS TRANSFER_SUM
				    , NVL(SUM(DECODE(OE.PAYMENT_METHOD_CD,'PAYMENT_METHOD_CD.MOBILE',DECODE(OE.ERP_ORDER_TYPE_CD, 'ERP_ORDER_TYPE_CD.RETURN', OE.PAYMENT_AMT*(-1), OE.PAYMENT_AMT),0)),0)	AS MOBILE_SUM
				    , NVL(SUM(DECODE(OE.PAYMENT_METHOD_CD,'PAYMENT_METHOD_CD.KAKAO',DECODE(OE.ERP_ORDER_TYPE_CD, 'ERP_ORDER_TYPE_CD.RETURN', OE.PAYMENT_AMT*(-1), OE.PAYMENT_AMT),0)),0)	AS KAKAO_SUM
				    , NVL(SUM(DECODE(OE.PAYMENT_METHOD_CD,'PAYMENT_METHOD_CD.CREDITSALE',DECODE(OE.ERP_ORDER_TYPE_CD, 'ERP_ORDER_TYPE_CD.RETURN', OE.PAYMENT_AMT*(-1), OE.PAYMENT_AMT),0)),0)	AS CREDITSALE_SUM
				    , NVL(SUM(DECODE(OE.PAYMENT_METHOD_CD,'PAYMENT_METHOD_CD.POINT',DECODE(OE.ERP_ORDER_TYPE_CD, 'ERP_ORDER_TYPE_CD.RETURN', OE.PAYMENT_AMT*(-1), OE.PAYMENT_AMT),0)),0)	AS POINT_SUM
				    , NVL(SUM(DECODE(OE.PAYMENT_METHOD_CD,'PAYMENT_METHOD_CD.DEPOSIT',DECODE(OE.ERP_ORDER_TYPE_CD, 'ERP_ORDER_TYPE_CD.RETURN', OE.PAYMENT_AMT*(-1), OE.PAYMENT_AMT),0)),0)	AS DEPOSIT_SUM
				    , NVL(SUM(DECODE(OE.PAYMENT_METHOD_CD,'PAYMENT_METHOD_CD.VOUCHER',DECODE(OE.ERP_ORDER_TYPE_CD, 'ERP_ORDER_TYPE_CD.RETURN', OE.PAYMENT_AMT*(-1), OE.PAYMENT_AMT),0)),0)	AS VOUCHER_SUM
				    , NVL(SUM(DECODE(OE.PAYMENT_METHOD_CD,'PAYMENT_METHOD_CD.CASH',DECODE(OE.ERP_ORDER_TYPE_CD, 'ERP_ORDER_TYPE_CD.RETURN', OE.PAYMENT_AMT*(-1), OE.PAYMENT_AMT),0)),0)		AS CASH_SUM
				    , NVL(SUM(DECODE(OE.PAYMENT_METHOD_CD,'PAYMENT_METHOD_CD.ETC',DECODE(OE.ERP_ORDER_TYPE_CD, 'ERP_ORDER_TYPE_CD.RETURN', OE.PAYMENT_AMT*(-1), OE.PAYMENT_AMT),0)),0)		AS ETC_SUM
				    , SUM(DECODE(OE.ERP_ORDER_TYPE_CD, 'ERP_ORDER_TYPE_CD.RETURN', OE.OWN_DC_AMT*(-1), OE.OWN_DC_AMT))					AS OWN_DC_AMT_SUM
				    , SUM(DECODE(OE.ERP_ORDER_TYPE_CD, 'ERP_ORDER_TYPE_CD.RETURN', OE.BUSINESS_DC_AMT*(-1), OE.BUSINESS_DC_AMT))			AS BIZ_DC_AMT_SUM
				    , SUM(DECODE(OE.ERP_ORDER_TYPE_CD, 'ERP_ORDER_TYPE_CD.RETURN', OE.PLUS_COUPON_DC_AMT*(-1), OE.PLUS_COUPON_DC_AMT))		AS PLUS_COUPON_DC_AMT_SUM
				    , SUM(DECODE(OE.ERP_ORDER_TYPE_CD, 'ERP_ORDER_TYPE_CD.RETURN', OE.ORDER_COUPON_DC_AMT*(-1), OE.ORDER_COUPON_DC_AMT))		AS ORDER_COUPON_DC_AMT_SUM
				    , SUM(DECODE(OE.ERP_ORDER_TYPE_CD, 'ERP_ORDER_TYPE_CD.RETURN', OE.DEPOSIT_AMT*(-1), OE.DEPOSIT_AMT))			AS DEPOSIT_AMT_SUM
				    , SUM(DECODE(OE.ERP_ORDER_TYPE_CD, 'ERP_ORDER_TYPE_CD.RETURN', OE.USE_POINT*(-1), OE.USE_POINT))				AS USE_POINT_SUM
				    , SUM(OE.CASH_REFUND_AMT)		AS CASH_REFUND_AMT_SUM
				    , SUM(OE.DEPOSIT_REFUND_AMT)	AS DEPOSIT_REFUND_AMT_SUM
				FROM OMS_ERPIF OE
				INNER JOIN CCS_BUSINESS CB
						ON CB.BUSINESS_ID = OE.BUSINESS_ID
					   AND CB.BUSINESS_TYPE_CD != 'BUSINESS_TYPE_CD.OWN'
					<if test="businessName != null and businessName != ''">
					   AND CB.NAME LIKE '%' || #{businessName} || '%')
					</if>
				WHERE OE.ERP_ORDER_TYPE_CD IN ('ERP_ORDER_TYPE_CD.SHIP','ERP_ORDER_TYPE_CD.RETURN')
				  AND OE.PAYMENT_METHOD_CD IN ('PAYMENT_METHOD_CD.CARD', 'PAYMENT_METHOD_CD.VIRTUAL', 'PAYMENT_METHOD_CD.TRANSFER',
				  		'PAYMENT_METHOD_CD.MOBILE', 'PAYMENT_METHOD_CD.KAKAO', 'PAYMENT_METHOD_CD.CREDITSALE', 'PAYMENT_METHOD_CD.POINT',
				  		'PAYMENT_METHOD_CD.DEPOSIT', 'PAYMENT_METHOD_CD.VOUCHER', 'PAYMENT_METHOD_CD.CASH', 'PAYMENT_METHOD_CD.ETC')
			  	  AND OE.FIXED_DT BETWEEN TO_DATE(#{saleDate}, 'YYYY-MM') AND LAST_DAY(TO_DATE(#{saleDate}, 'YYYY-MM'))
			  	  AND OE.SALE_TYPE_CD = 'SALE_TYPE_CD.CONSIGN'
			  	  AND OE.PURCHASE_YN = 'N'
		  	  	<if test="businessId != null and businessId != ''">
				   AND OE.BUSINESS_ID = #{businessId}
				</if>
				<if test="erpBusinessId != null and erpBusinessId != ''">
				   AND OE.ERP_BUSINESS_ID = #{erpBusinessId})
				</if>
			  	GROUP BY CB.BUSINESS_ID
			  			, CB.NAME
			  			, OE.SALEPRODUCT_ID
			  			, OE.COMMISSION_RATE )
		  	GROUP BY BUSINESS_ID, BUSINESS_NAME
		  	ORDER BY BUSINESS_NAME
		<include refid="ccs.common.pagingPost" />
	</select>

	<select id="getSettleBizDetailList" parameterType="omsSettleSearch" resultType="omsSettle">
	/* [oms.settlebiz.getSettleBizDetailList][peter][2016. 10. 18.] */
		<include refid="ccs.common.pagingPre" />
			SELECT 
			    TO_CHAR(OE.FIXED_DT, 'YYYY/MM/DD')		AS SALE_STANDARD_DT
			    , TO_CHAR(OO.ORDER_DT, 'YYYY/MM/DD')	AS ORDER_DT
			    , OE.ORDER_ID
			    , OE.BUSINESS_ID
			    , OE.BUSINESS_NAME
			    , OE.ERP_BUSINESS_ID
			    , NVL(OE.PRODUCT_ID, '-')				AS PRODUCT_ID
			    , OE.PRODUCT_NAME
			    , OE.SALEPRODUCT_ID
			    , OE.SALEPRODUCT_NAME
			    , OE.SUPPLY_PRICE
			    , OE.TOTAL_SALE_PRICE					AS SALE_PRICE
			    , DECODE(OE.ERP_ORDER_TYPE_CD, 'ERP_ORDER_TYPE_CD.RETURN', (OE.SUPPLY_PRICE * OE.QTY)*(-1), (OE.SUPPLY_PRICE * OE.QTY))		AS SUPPLY_AMT
			    , DECODE(OE.ERP_ORDER_TYPE_CD, 'ERP_ORDER_TYPE_CD.RETURN', OE.SALE_AMT*(-1), OE.SALE_AMT)				AS SALE_AMT
			    , OE.COMMISSION_RATE
			    , CASE WHEN OE.ERP_ORDER_TYPE_CD = 'ERP_ORDER_TYPE_CD.RETURN'
			    		THEN ROUND(OE.SALE_AMT * (OE.COMMISSION_RATE / 100), 0) * (-1)
			    	   ELSE	ROUND(OE.SALE_AMT * (OE.COMMISSION_RATE / 100), 0)
			      END									AS CHARGE_AMT
			    , OE.PAYMENT_METHOD_CD
			    , 0										AS PAYMENT_AMT
			    , CASE WHEN OE.ERP_ORDER_TYPE_CD = 'ERP_ORDER_TYPE_CD.RETURN'
			    		THEN (OE.USE_POINT + OE.DEPOSIT_AMT - OE.CASH_REFUND_AMT - OE.DEPOSIT_REFUND_AMT) * (-1)
			    	   ELSE	(OE.USE_POINT + OE.DEPOSIT_AMT - OE.CASH_REFUND_AMT - OE.DEPOSIT_REFUND_AMT)
			      END									AS ETC_AMT
			    , CASE WHEN OE.ERP_ORDER_TYPE_CD = 'ERP_ORDER_TYPE_CD.RETURN'
			    		THEN (OE.OWN_DC_AMT + OE.PLUS_COUPON_DC_AMT + OE.ORDER_COUPON_DC_AMT) * (-1)
			    	   ELSE (OE.OWN_DC_AMT + OE.PLUS_COUPON_DC_AMT + OE.ORDER_COUPON_DC_AMT)
			      END									AS OWN_COUPON_AMT
			    , DECODE(OE.ERP_ORDER_TYPE_CD, 'ERP_ORDER_TYPE_CD.RETURN', OE.BUSINESS_DC_AMT*(-1), OE.BUSINESS_DC_AMT)			AS BIZ_COUPON_AMT
			    , CASE WHEN OE.ERP_ORDER_TYPE_CD = 'ERP_ORDER_TYPE_CD.RETURN'
			    		THEN (OE.SALE_AMT - ROUND(OE.SALE_AMT * (OE.COMMISSION_RATE / 100), 0) - OE.BUSINESS_DC_AMT) * (-1)
			    	   ELSE (OE.SALE_AMT - ROUND(OE.SALE_AMT * (OE.COMMISSION_RATE / 100), 0) - OE.BUSINESS_DC_AMT)
			      END									AS SUPPORT_AMT
			    , DECODE(OE.ERP_ORDER_TYPE_CD, 'ERP_ORDER_TYPE_CD.RETURN', OE.QTY*(-1), OE.QTY)			AS QTY
			    , OP.CATEGORY_ID
			    , (SELECT NAME FROM PMS_CATEGORY WHERE CATEGORY_ID = OP.CATEGORY_ID AND USE_YN = 'Y')	AS CATEGORY_NAME
			    , OE.TAX_TYPE_CD
			    , OC.CLAIM_TYPE_CD
			    , OE.CLAIM_NO
			FROM OMS_ERPIF OE
			INNER JOIN OMS_ORDER OO
					ON OO.ORDER_ID = OE.ORDER_ID
			LEFT OUTER JOIN OMS_ORDERPRODUCT OP
						 ON OP.ORDER_ID = OE.ORDER_ID
				   		AND OP.ORDER_PRODUCT_NO = OE.ORDER_PRODUCT_NO
			LEFT OUTER JOIN OMS_CLAIM OC
						 ON OC.ORDER_ID = OE.ORDER_ID
						AND OC.CLAIM_NO = OE.CLAIM_NO
			WHERE OE.ERP_ORDER_TYPE_CD IN ('ERP_ORDER_TYPE_CD.SHIP','ERP_ORDER_TYPE_CD.RETURN')
			  AND OE.FIXED_DT BETWEEN TO_DATE(#{saleDate}, 'YYYY-MM') AND LAST_DAY(TO_DATE(#{saleDate}, 'YYYY-MM'))
			  AND OE.PAYMENT_METHOD_CD IN ('PAYMENT_METHOD_CD.CARD', 'PAYMENT_METHOD_CD.VIRTUAL', 'PAYMENT_METHOD_CD.TRANSFER',
				  		'PAYMENT_METHOD_CD.MOBILE', 'PAYMENT_METHOD_CD.KAKAO', 'PAYMENT_METHOD_CD.CREDITSALE', 'PAYMENT_METHOD_CD.POINT',
				  		'PAYMENT_METHOD_CD.DEPOSIT', 'PAYMENT_METHOD_CD.VOUCHER', 'PAYMENT_METHOD_CD.CASH', 'PAYMENT_METHOD_CD.ETC')
			  AND OE.SALE_TYPE_CD = 'SALE_TYPE_CD.CONSIGN'
			  AND OE.PURCHASE_YN = 'N'
		 	<if test="businessId != null and businessId != ''">
			   AND OE.BUSINESS_ID = #{businessId}
			</if>
			<if test="erpBusinessId != null and erpBusinessId != ''">
			   AND OE.ERP_BUSINESS_ID = #{erpBusinessId})
			</if>
			ORDER BY OE.FIXED_DT, OE.ORDER_ID DESC
		<include refid="ccs.common.pagingPost" />
	</select>

</mapper>